{% extends "base.html" %}
{% load qr_code %}

{% block content %}
<div class="container">
    <div class="receipt-container">
        <!-- Receipt Header -->
        <div class="receipt-header">
            <h3 class="mb-1">
                <i class="fas fa-receipt me-2 text-primary"></i>ðŸ§¾ Receipt
            </h3>
            <p class="text-muted mb-0">Order #{{ order.id }}</p>
        </div>

        <!-- Order Info -->
        <div class="row mb-3">
            <div class="col-6">
                <p class="mb-1"><strong>Receipt No:</strong></p>
                <p class="text-muted small">{{ receipt_no }}</p>
            </div>
            <div class="col-6 text-end">
                <p class="mb-1"><strong>Date:</strong></p>
                <p class="text-muted small">{{ transaction_date }}</p>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-6">
                <p class="mb-1"><strong>Phone:</strong></p>
                <p class="text-muted small">{{ phone_number }}</p>
            </div>
            <div class="col-6 text-end">
                <p class="mb-1"><strong>Status:</strong></p>
                <span id="order-status">
                    {% if order.status == "PAID" %}
                        <span class="badge bg-success">Paid</span>
                    {% elif order.status == "PENDING" %}
                        <span class="badge bg-warning text-dark">Pending</span>
                    {% else %}
                        <span class="badge bg-danger">{{ order.status }}</span>
                    {% endif %}
                </span>
            </div>
        </div>

        <!-- MPesa Receipt -->
        {% if payment and payment.mpesa_receipt_no %}
        <div class="alert alert-success mb-3">
            <p class="mb-0 small">
                <i class="fas fa-check-circle me-1"></i>
                <strong>M-Pesa Receipt:</strong> {{ payment.mpesa_receipt_no }}
            </p>
        </div>
        {% endif %}

        <!-- Order Items -->
        <div class="receipt-items">
            <table class="table table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Product</th>
                        <th class="text-center">Qty</th>
                        <th class="text-end">Price</th>
                        <th class="text-end">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in order.items.all %}
                    <tr>
                        <td>{{ item.product.name }}</td>
                        <td class="text-center">{{ item.quantity }}</td>
                        <td class="text-end">KES {{ item.price|floatformat:2 }}</td>
                        <td class="text-end">KES {{ item.subtotal|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-end fw-bold">Total:</td>
                        <td class="text-end fw-bold text-success h5 mb-0">KES {{ order.total_price|floatformat:2 }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- QR Code -->
        <div class="text-center my-3">
            {% qr_from_text request.build_absolute_uri|slice:":-10"|add:order.id|add:"/order/verify/"|add:order.id|stringformat:"s" size="L" image_format="png" %}
            <p class="small text-muted mt-2">
                <i class="fas fa-qrcode me-1"></i>Scan to verify this order
            </p>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex flex-wrap gap-2 justify-content-center mt-4">
            <a href="{% url 'receipt_pdf' order.id %}" class="btn btn-danger">
                <i class="fas fa-file-pdf me-1"></i>Download PDF
            </a>
            
            {% if payment and payment.mpesa_receipt_no %}
            {% with phone=order.customer.phone_number|default:"254700000000" %}
            <a href="https://wa.me/{{ phone|slice:"3:" }}?text={{ "âœ… Order #"|add:order.id|add:" has been PAID. Receipt: "|add:payment.mpesa_receipt_no|add:". Total: KES "|add:order.total_price|floatformat:2|urlencode }}" 
               target="_blank" class="btn btn-success">
                <i class="fab fa-whatsapp me-1"></i>Share on WhatsApp
            </a>
            {% endwith %}
            {% endif %}
            
            {% if order.status != "PAID" %}
            <button id="refresh-btn" class="btn btn-primary" onclick="checkPaymentStatus()">
                <i class="fas fa-sync-alt me-1"></i>Refresh Status
            </button>
            {% endif %}
        </div>

        <!-- Message -->
        <div class="text-center mt-4">
            <p class="text-muted mb-0">
                <i class="fas fa-heart text-danger me-1"></i>
                Thank you for shopping with us!
            </p>
            <small class="text-muted">Please come again</small>
        </div>
    </div>
</div>

<!-- Script to check payment status -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const refreshBtn = document.getElementById("refresh-btn");
    const orderStatus = document.getElementById("order-status");

    function checkStatus() {
        showLoading('Checking payment status...');
        
        fetch("{% url 'check_payment_status' order.id %}")
            .then(res => res.json())
            .then(data => {
                if (data.status === "PAID") {
                    orderStatus.innerHTML = '<span class="badge bg-success">Paid</span>';
                    showToast('success', 'Payment successful!');
                    if (refreshBtn) {
                        refreshBtn.style.display = "none";
                    }
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    orderStatus.innerHTML = '<span class="badge bg-warning text-dark">' + data.status + '</span>';
                    showToast('info', 'Payment is still pending. Please complete payment on your phone.');
                }
                hideLoading();
            })
            .catch(error => {
                console.log("Error checking payment status.");
                hideLoading();
            });
    }

    // Manual refresh
    if (refreshBtn) {
        refreshBtn.addEventListener("click", checkStatus);
    }

    // Auto-refresh every 10 seconds until paid
    const interval = setInterval(function () {
        checkStatus();
    }, 10000);
});
</script>
{% endblock %}

