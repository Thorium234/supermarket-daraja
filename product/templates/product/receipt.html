{% extends "base.html" %}
{% load qr_code %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-3">ğŸ§¾ Receipt for Order #{{ order.id }}</h2>
    <p>Thank you for shopping with us!</p>

    <!-- Order Info -->
    <div class="row mb-3">
        <div class="col-md-6">
            <p><b>Receipt No:</b> {{ receipt_no }}</p>
            <p><b>Date:</b> {{ transaction_date }}</p>
            <p><b>Phone:</b> {{ phone_number }}</p>
            
            <!-- âœ… Show M-Pesa receipt if available -->
            {% if payment and payment.mpesa_receipt_no %}
                <p><b>Mpesa Receipt No:</b> {{ payment.mpesa_receipt_no }}</p>
            {% endif %}

            <p><b>Status:</b>
                <span id="order-status">
                    {% if order.status == "PAID" %}
                        <span class="badge bg-success">Paid</span>
                    {% elif order.status == "PENDING" %}
                        <span class="badge bg-warning text-dark">Pending</span>
                    {% else %}
                        <span class="badge bg-danger">Cancelled</span>
                    {% endif %}
                </span>
            </p>
        </div>
        <div class="col-md-6 text-end">
            <!-- âœ… QR Code (order verification) -->
            {% qr_from_text request.build_absolute_uri|cut:request.get_full_path|add:"order/verify/"|add:order.id|stringformat:"s" size="L" image_format="png" %}
            <p class="small mt-2">ğŸ“± Scan to verify this order</p>
        </div>
    </div>

    <!-- Order Items -->
    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Price (Ksh)</th>
                <th>Subtotal</th>
            </tr>
        </thead>
        <tbody>
            {% for item in order.items.all %}
            <tr>
                <td>{{ item.product.name }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.price }}</td>
                <td>{{ item.subtotal }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h4 class="mt-3">ğŸ’° Total: <b>Ksh {{ order.total_price }}</b></h4>

    <!-- PDF Download Button -->
    <a href="{% url 'receipt_pdf' order.id %}" class="btn btn-danger mt-3">
        ğŸ“ Download PDF
    </a>

    <!-- âœ… Send via WhatsApp -->
    <a href="https://wa.me/{{ phone_number }}?text=âœ… Your order #{{ order.id }} has been PAID. 
    Download receipt here: {{ request.build_absolute_uri }}"
    target="_blank" class="btn btn-success mt-3 ms-2">
    ğŸ’¬ Send via WhatsApp
    </a>

    <!-- âœ… Send via SMS -->
    <a href="{% url 'send_receipt_sms' order.id %}" class="btn btn-primary mt-3 ms-2">
    ğŸ“© Send via SMS
    </a>

    <!-- âœ… Refresh Now Button (only if not paid) -->
    {% if order.status != "PAID" %}
    <button id="refresh-btn" class="btn btn-primary mt-3 ms-2">
        ğŸ”„ Refresh Now
    </button>
    {% endif %}
</div>

<!-- Script to check payment status -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const refreshBtn = document.getElementById("refresh-btn");
    const orderStatus = document.getElementById("order-status");

    function checkStatus() {
        fetch("{% url 'check_payment_status' order.id %}")
            .then(res => res.json())
            .then(data => {
                if (data.status === "PAID") {
                    orderStatus.innerHTML = '<span class="badge bg-success">Paid</span>';
                    if (refreshBtn) refreshBtn.style.display = "none"; // hide button
                    location.reload(); // reload to update receipt with payment details
                } else {
                    orderStatus.innerHTML =
                        '<span class="badge bg-warning text-dark">' + data.status + '</span>';
                }
            })
            .catch(() => console.log("Error checking payment status."));
    }

    // âœ… Manual refresh
    if (refreshBtn) {
        refreshBtn.addEventListener("click", checkStatus);
    }

    // âœ… Auto-refresh every 10 seconds until paid
    const interval = setInterval(function () {
        checkStatus();
    }, 10000);
});
</script>

{% endblock %}
