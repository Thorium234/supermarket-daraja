{% extends "owner/base.html" %}

{% block owner_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Dashboard Overview</h3>
    <form method="get" class="d-flex gap-2">
        <select name="period" class="form-select" onchange="this.form.submit()">
            <option value="today" {% if period == 'today' %}selected{% endif %}>Today</option>
            <option value="week" {% if period == 'week' %}selected{% endif %}>This Week</option>
            <option value="month" {% if period == 'month' %}selected{% endif %}>This Month</option>
        </select>
    </form>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3"><div class="card border-0 shadow-sm"><div class="card-body"><small class="text-muted">Products</small><h3>{{ total_products }}</h3></div></div></div>
    <div class="col-md-3"><div class="card border-0 shadow-sm"><div class="card-body"><small class="text-muted">Orders</small><h3>{{ total_orders }}</h3></div></div></div>
    <div class="col-md-3"><div class="card border-0 shadow-sm"><div class="card-body"><small class="text-muted">Paid Orders</small><h3>{{ paid_orders }}</h3></div></div></div>
    <div class="col-md-3"><div class="card border-0 shadow-sm"><div class="card-body"><small class="text-muted">Revenue</small><h3>KES {{ revenue|floatformat:2 }}</h3></div></div></div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-8"><div class="card shadow-sm"><div class="card-header">Sales Trend (14 days)</div><div class="card-body"><canvas id="salesTrendChart" height="120"></canvas></div></div></div>
    <div class="col-lg-4"><div class="card shadow-sm"><div class="card-header">Payment Split</div><div class="card-body"><canvas id="paymentSplitChart" height="220"></canvas></div></div></div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header">Recent Orders</div>
    <div class="table-responsive">
        <table class="table mb-0">
            <thead><tr><th>#</th><th>Customer</th><th>Status</th><th>Total</th><th>Date</th><th></th></tr></thead>
            <tbody>
                {% for order in recent_orders %}
                <tr>
                    <td>#{{ order.id }}</td>
                    <td>{{ order.customer.phone_number|default:order.customer_name }}</td>
                    <td><span class="badge text-bg-secondary">{{ order.status }}</span></td>
                    <td>KES {{ order.total_price|floatformat:2 }}</td>
                    <td>{{ order.created_at|date:"Y-m-d H:i" }}</td>
                    <td><a href="{% url 'owner:order_detail' order.id %}" class="btn btn-sm btn-outline-primary">Open</a></td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="text-center py-3">No orders in this period.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header">Low Stock Alerts</div>
    <div class="card-body">
        {% if low_stock %}
        <div class="row g-2">
            {% for product in low_stock %}
            <div class="col-md-4"><div class="border rounded p-2 d-flex justify-content-between"><span>{{ product.name }}</span><span class="badge text-bg-danger">{{ product.stock }}</span></div></div>
            {% endfor %}
        </div>
        {% else %}
        <p class="mb-0">No low stock products.</p>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const salesTrend = JSON.parse('{{ sales_trend|escapejs }}');
const paymentSplit = JSON.parse('{{ payment_split|escapejs }}');

new Chart(document.getElementById('salesTrendChart'), {
  type: 'line',
  data: {
    labels: salesTrend.labels,
    datasets: [{label: 'Revenue', data: salesTrend.totals, borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,0.12)', fill: true, tension: 0.2}]
  }
});

new Chart(document.getElementById('paymentSplitChart'), {
  type: 'doughnut',
  data: {
    labels: ['Paid', 'Pending', 'Failed', 'Refunded'],
    datasets: [{data: [paymentSplit.paid, paymentSplit.pending, paymentSplit.failed, paymentSplit.refunded]}]
  }
});
</script>
{% endblock %}
